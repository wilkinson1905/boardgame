# 実装ステップ計画書

受領内容: `siyousho.md` を前提として、Pythonで段階的にゲームを実装していく計画を作成する。

目的: 仕様書をコードに落とし込むために、リスクの低い順に機能を分割し、小さな検証可能なマイルストーンで実装する。

重要な前提（仮定）
- 言語: Python 3.10+ を想定
- 既存ファイル: `pyproject.toml` があるため、依存管理はそこに追記する想定
- UI: 最初はコマンドライン（CLI）で動くプロトタイプを作り、後でGUI/ウェブに拡張する

実装チェックリスト（ユーザー要求から抽出）
- ヘックスマップでのターン制: 実装対象
- 補給（倉庫→トラック→前線）: 実装対象
- トラック数=5: 初期データに反映
- 工兵と道路アップグレード: 段階的に実装（初期は簡易版）
- トラック移動: MP=6、未改良道コスト=2 のルール適用
- フェーズ順: 移動→攻撃→食事 を実装
- 攻撃ルール: 弾薬消費と兵力比による確率モデルを実装
- 勝利条件: 兵士数0で敗北を実装

ステップ一覧（各ステップは実装・テスト・レビューで完了）

Step 0 — 準備（成果物: リポジトリの小調整）
- 目的: 開発環境と最小ファイル構造を整備
- やること:
  - `pyproject.toml` を確認し必要ならテスト依存（pytest）を追加
  - `README.md` に開発手順の簡易追記
- 検証基準: pytest が実行できること（空のテストで成功）

Step 1 — データモデルとユニットテスト（成果物: module `model.py` とテスト）
- 目的: マップ、ヘックス、トラック、プレイヤー状態などのコアデータ構造を定義
- やること:
  - `board/map.py`: Hex, Map クラス（座標系、隣接取得、terrain, road_upgraded フラグ）
  - `entities.py`: PlayerState, Truck, Warehouse, Engineer の dataclass 定義
  - `rules/constants.py`: チューニング用パラメータ（MP, 初期兵数等）
  - 単体テスト: データ生成・隣接検索・基本状態検証
- 検証基準: 型エラーなし、テストが通る

Step 2 — トラック移動ロジック（成果物: `movement.py` とテスト）
- 目的: MP と地形コストに従ったトラック移動を実装
- やること:
  - トラックの移動関数（移動可能範囲計算、経路コスト計算）
  - 積載モデル（容量チェック）
  - 移動時の荷降ろしインターフェース（降ろす/搭載するAPI）
  - 単体テスト: 簡易マップ上での移動シナリオ
- 検証基準: MP6で期待どおり移動できる（未改良道は2コスト）

Step 3 — 補給（搭載・荷降ろし）と倉庫（成果物: `supply.py` とテスト）
- 目的: 倉庫からトラックへの搭載、トラックから前線への荷降ろしを実装
- やること:
  - 搭載/荷降ろし API（容量上限のチェック）
  - 倉庫の初期補給ルール（初期値の指定）
  - 単体テスト: トラックに物資を積んで降ろすフロー
- 検証基準: 容量制限・在庫増減が正しく反映される

Step 4 — 工兵と道路アップグレード（成果物: `engineering.py` とテスト）
- 目的: 工兵による道路アップグレードの基本動作を実装
- やること:
  - 工兵の移動/降車/改良開始/完了処理
  - ターン経過での改良完了ロジック
  - 単体テスト: 改良開始→次ターンに道路がアップグレードされること
- 検証基準: road_upgraded が真に変化する

Step 5 — 戦闘（成果物: `combat.py` とテスト）
- 目的: 弾薬消費と兵力比に基づく確率判定の戦闘解決を実装
- やること:
  - 攻撃コマンド API（弾薬チェック、攻撃参加数の指定）
  - 確率関数実装（仕様書の式を初期実装）
  - ダメージ適用ロジック
  - 単体テスト: 乱数を固定化して成功/失敗のケースを検証
- 検証基準: 弾薬が消費され、攻撃結果が期待どおり適用される

Step 6 — ターン処理とフェーズ管理（成果物: `game_engine.py` と結合テスト）
- 目的: 移動→攻撃→食事という1ラウンドのフローを統合する
- やること:
  - ターンループの実装（各プレイヤーの移動→攻撃→食事を順序通り実行）
  - 食事フェーズのロジック（食料消費と欠食ペナルティ）
  - 結合テスト: 数ラウンドをシミュレートして状態遷移を確認
- 検証基準: フェーズが順序通り実行され、勝利条件が正しく検出される

Step 7 — CLI プレイアブル・プロトタイプ（成果物: `cli.py`）
- 目的: ユーザーがコマンドラインでゲームを操作できるようにする
- やること:
  - ゲーム開始、トラック選択、移動入力、攻撃指定、表示ロジック
  - 簡易マップ表示（テキスト）
  - マニュアル/ヘルプ出力
- 検証基準: 最低限1対1の最小ゲームがプレイできる

Step 8 — リファクタ・ドキュメント・テスト拡充
- 目的: コード品質を高め、拡張しやすくする
- やること:
  - 型注釈の追加、docstring、README の更新
  - 主要ロジックに対するユニットテスト拡充
  - CI用の簡易設定（GitHub Actions等、必要なら）

Step 9 — プレイテストとパラメータ調整
- 目的: バランス調整とパラメータセット作成
- やること:
  - 自動ランダムプレイでログを収集するシミュレータを作成
  - 指標（平均勝利ターン、勝率、補給不足頻度）を収集
  - パラメータを3セット用意（緩い/標準/厳しい）

安定化フェーズ — 拡張・GUI化（任意）
- Web/GUI フロントエンド、AI 対戦プレイヤー、マップエディタなど

各ステップの「契約」（入力/出力/成功条件）
- 例（Step2 トラック移動）:
  - 入力: Map インスタンス、Truck インスタンス、経路（hex id list）
  - 出力: 更新された Truck.position, remainingMP, Map の occupants
  - エラー: 経路が存在しない/容量超過/MP不足 の場合は例外または明示的なエラーを返す

主要なエッジケース（要注意）
- 経路が長すぎてMPを超える
- トラックがスタック上限を越える
- 食料/弾薬の負の在庫
- 工兵が改良途中で死亡

品質ゲート（各マイルストーン合格条件）
- build: Python ファイルが構文エラーを起こさない
- lint/typecheck: mypy/flake8 を導入する場合は主要ファイルで問題がない
- unit tests: 各ステップで最低1つのテストが存在し成功する
- smoke test: CLI で最小ゲームが一通り実行できる

予定（見積）
- Step0〜2: 1〜3日
- Step3〜6: 3〜7日（戦闘とターン処理に時間がかかる）
- Step7〜9: 追加 1〜2 週間（拡張次第）

次のアクション（私が実行可能）
1. あなたの確認後、Step0 を実行して `pyproject.toml` に pytest を追加し、最初のテストを追加します。
2. 承認があれば Step1 の実装に着手します。

注: ここでは実装は行いません。実装を始めてよい場合は "Step0 を実行して" など次に進める指示をください。
