# GUI 実装ステップ計画（pygame）

目的: `siyousho.md` のルールを前提に、Python + pygame でゲームのフロントエンドを段階的に実装する。小さなマイルストーン毎に動作検証とテストを行い、安全に機能を追加する。

前提
- コアゲームロジックは既に `board` パッケージで実装済み（map, entities, movement, combat, engine 等）。
- 依存: `pygame`（`pyproject.toml` に追記済み）
- 目標UI: 六角（ヘックス）マップ表示、トラック・ユニットの描画、移動コマンド、攻撃コマンド、簡易HUD

共通の品質ゲート
- ビルド/起動: pygame ウィンドウが起動する
- Lint/typecheck: 主要モジュールで構文エラーなし
- Smoke test: 最低1つの自動化スクリプトでウィンドウを短時間立ち上げられる

チェックリスト（各ステップは完了条件込み）

Step G0 — 設計とアセット整理 (成果物: `step_gui.md` + assets フォルダ構成)
- 目的: UI 要件を固め、アセット（アイコン、フォント）と座標系（ヘックス座標→画面座標変換）を決定
- 完了条件: `step_gui.md` を作成、`assets/` フォルダを作る（プレースホルダで可）

Step G1 — 最小起動テンプレート（成果物: `gui.py` のベース）
- 目的: pygame ウィンドウを作り、ループと基本的なイベント処理を用意する
- 実装内容:
  - ウィンドウ初期化、FPS 管理、Esc/閉じるで終了
  - シンプルな描画ループ（背景色とログ表示）
- 検証: `python gui.py` でウィンドウが開く（手動）

Step G2 — マップ描画（成果物: マップ描画モジュール）
- 目的: `board.Map` を受け取り、ヘックス（もしくは簡易円）を画面に描画する
- 実装内容:
  - ヘックス座標系（axial）→スクリーン座標変換関数
  - タイルの色分け（terrain, upgraded road の表示）
  - ズーム/パンは最初は不要（後で追加）
- 検証: demo マップを読み込み、全タイルが見える

Step G3 — ユニット/トラックの描画（成果物: ユニットレンダラ）
- 目的: トラック・兵士・工兵をタイル上に描画する
- 実装内容:
  - トラックは矩形/アイコンで表現、所有者カラーを付与
  - 数字ラベルで兵数や残MPを表示
  - 描画は z-order（地形→トラック→選択ハイライト）
- 検証: デモシーンでトラックがマップ上に表示される

Step G4 — 選択とコマンド入力（成果物: 選択・コマンド UI）
- 目的: マウスでトラックを選択し、クリックで目的地を指定して移動キューを作る
- 実装内容:
  - クリック検出（ヘックス判定）と選択ハイライト
  - 移動プレビュー（選択→マウス移動で経路を示す簡易表示）
  - 移動コマンド発行: GameEngine.queue_move を呼ぶ
- 検証: 選択と移動キューができる（HUD にキュー情報表示）

Step G5 — 経路探索とコスト表示（成果物: 経路探索モジュール）
- 目的: MAP 上で移動可能範囲と経路コストを表示する（A* または BFS）
- 実装内容:
  - 簡易 A*（ヘックス用）で経路を計算
  - 経路コストに基づく移動可否判定（MP 表示）
  - 未改良/改良道路のコスト差を視覚化
- 検証: 経路を計算し、MP が足りない場合は赤表示、足りる場合は緑表示

Step G6 — 行動フェーズ実行とアニメーション（成果物: フェーズ実行ボタンと簡易アニメ）
- 目的: プレイヤー操作後、Round 実行（movement→attack→food）を視覚的に確認する
- 実装内容:
  - 「Run Round」ボタンを配置
  - トラック移動の簡易アニメーション（経路を沿って一定速度で移動）
  - 攻撃結果のポップ表示（ヒット・ダメージ）
- 検証: Run ボタンでトラックが動き、HUD が更新される

Step G7 — HUD・詳細パネル（成果物: 選択ユニットの詳細表示）
- 目的: 選択中のトラック・倉庫・プレイヤーの詳細（積載、兵力、弾薬、食料）を表示
- 実装内容:
  - サイドパネルに情報表示、ボタンで搭載/降ろし操作（簡易）
- 検証: パネルで数値が正しく変化する

Step G8 — 工兵と道路改良 UI（成果物: 改良操作の UI）
- 目的: 工兵を選択して改良を開始し、改良の進行状況を視覚化
- 実装内容:
  - 改良開始コマンド、進捗バーの表示
- 検証: 改良を開始→一定ターンで道路表示が変わる

Step G9 — プレイテスト用ツールとログ（成果物: プレイログ・スクリーンショット）
- 目的: プレイテストを効率化するためのログ出力とリプレイ機能（簡易）
- 実装内容:
  - 行動ログ、勝敗ログをファイルに保存
  - スクリーンショット保存ショートカット
- 検証: ログファイルにラウンドごとのイベントが出力される

Step G10 — リファクタ／最適化／QA（成果物: ドキュメントと安定版）
- 目的: コードの可読性・パフォーマンス・テストを強化
- 実装内容:
  - 型注釈、分割、不要処理の削減
  - 主要UIコンポーネントの単体テスト（ロジック部分）
  - 実行速度のプロファイル
- 検証: 全テストパス、軽微な UI フリーズやフレーム落ちがない

テストと実行コマンド
- GUI の手動確認: `python gui.py` を実行。表示・操作を手動で検証する。
- 自動テスト（ユニット）: pygame の描画は手動確認が主だが、ロジック部分（座標変換、経路探索）は pytest でテスト可能。
  - 例: `python -m pytest tests/test_movement.py tests/test_engineering.py`

ドキュメント／アセット配置
- `assets/` にアイコンやフォントを格納。最初はデフォルトフォントと簡易図形で実装する。

リスクと回避策
- pygame の依存と環境差: ユーザ環境に pygame インストールが必要。CI でのチェックは限定的。
- 高負荷(大量エンティティ): 描画を差分更新にする、FPS を 30 に制限する。

次のアクション（私が実行可能）
1. この計画をあなたが確認後、Step G1 の実装（最小起動テンプレート）に着手します。
2. その後、G2→G3 と段階的に実装していきます。

---

Prepared for: pygame GUI implementation plan
